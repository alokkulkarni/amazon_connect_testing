# Lambda Regression Testing with LocalStack

Automated regression tests for AWS Lambda functions using
[testcontainers-localstack](https://testcontainers-python.readthedocs.io/en/latest/modules/localstack/).

A Docker container running LocalStack is started once per test session.
Lambda functions are deployed into it, invoked with test event payloads, and
assertions are run against the responses, DynamoDB tables, and S3 objects.
A JSON + HTML test report is written to `reports/` after each run.

---

## Directory Structure

```
lambda_testing/
├── test_lambda_localstack.py  # pytest test runner (parametrised)
├── lambda_test_cases.json     # all test case definitions
├── conftest.py                # report hooks (JSON + console table)
├── sample_lambda.py           # Lambda handlers used by the test suite
├── run_lambda_tests.sh        # shell entry point (cwd-independent)
├── requirements.txt           # Python dependencies
├── reports/                   # generated after each run (git-ignored)
│   ├── lambda_test_report.json
│   └── lambda_test_report.html
└── README.md                  # this file
```

---

## Prerequisites

- **Docker** (Desktop or Engine) – must be running before tests start.
- **Python 3.9+**

---

## Setup

From the repo root:

```bash
pip install -r requirements.txt
```

Or install only the lambda testing dependencies:

```bash
pip install boto3 botocore pytest pytest-html testcontainers[localstack] python-dotenv
```

---

## Running Tests

### Shell script (recommended – works from any directory)

```bash
# from repo root:
./lambda_testing/run_lambda_tests.sh

# from inside lambda_testing/:
./run_lambda_tests.sh
```

Filter by test case name or stop on first failure:

```bash
PYTEST_ARGS="-k TC-001 -x" ./lambda_testing/run_lambda_tests.sh
```

### Direct pytest

```bash
cd lambda_testing
pytest -s -v --html=reports/lambda_test_report.html --self-contained-html test_lambda_localstack.py
```

---

## Test Reports

After each run two report files are written to `lambda_testing/reports/`:

| File | Format | Description |
|------|--------|-------------|
| `lambda_test_report.json` | JSON | Machine-readable per-test pass/fail/skip, duration, error text |
| `lambda_test_report.html` | HTML | Human-readable, generated by pytest-html |

A pass/fail summary table is also printed to the console at the end of every run.

---

## Test Case Format (`lambda_test_cases.json`)

```json
{
  "name": "TC-001 S3 event → DynamoDB writer (happy path)",
  "description": "Human-readable description",
  "function_name": "my-function",
  "handler": "lambda_function.my_handler",
  "timeout": 10,
  "memory_size": 128,
  "environment_variables": { "TABLE_NAME": "MyTable" },
  "setup": {
    "s3_buckets": ["my-bucket"],
    "dynamodb_tables": [
      {
        "TableName": "MyTable",
        "KeySchema": [{"AttributeName": "id", "KeyType": "HASH"}],
        "AttributeDefinitions": [{"AttributeName": "id", "AttributeType": "S"}],
        "BillingMode": "PAY_PER_REQUEST"
      }
    ]
  },
  "trigger_event": { "key": "value" },
  "validations": {
    "lambda_response": {
      "statusCode": 200,
      "body": "\"exact body string\"",
      "body_contains": "partial match"
    },
    "dynamodb_item": {
      "TableName": "MyTable",
      "Key": { "id": { "S": "some-id" } },
      "ExpectedAttributeValue": { "status": { "S": "DONE" } }
    },
    "s3_object": {
      "Bucket": "my-bucket",
      "Key": "output/result.json",
      "ExpectedContent": "{\"ok\": true}",
      "ContentContains": "ok"
    },
    "expected_function_error": "Unhandled"
  }
}
```

### Validation fields

| Field | Description |
|-------|-------------|
| `lambda_response.statusCode` | Exact match on HTTP status code |
| `lambda_response.body` | Exact match on response body string |
| `lambda_response.body_contains` | Substring match on response body |
| `dynamodb_item` | Fetches an item by key and checks attribute values |
| `s3_object` | Fetches an S3 object and checks its content |
| `expected_function_error` | Set to `"Unhandled"` or `"Handled"` to assert that the Lambda raised an exception |

---

## Included Test Cases

| ID | Name | What is tested |
|----|------|----------------|
| TC-001 | S3 event → DynamoDB writer | Happy path: S3 event parsed, DynamoDB item written, 200 returned |
| TC-002 | Simple greeting function | Env var injection, string formatting, 200 returned |
| TC-003 | Lambda writes output to S3 | Lambda puts an S3 object; content validated via `s3_object` |
| TC-004 | Environment variable passthrough | All declared env vars appear in the Lambda runtime |
| TC-005 | Invalid S3 event structure | Malformed payload → 400 error path |
| TC-006 | Missing required env var | No `TABLE_NAME` → 500 error path |
| TC-007 | Unhandled exception | Lambda raises → `FunctionError` detected |
| TC-008 | DynamoDB conditional write | `attribute_not_exists` condition → 201 on first write |

---

## Adding New Test Cases

1. Add a handler to `sample_lambda.py` (or point to your own Lambda source).
2. Append a test case to `lambda_test_cases.json` using the format above.
3. Run the suite to verify: `./run_lambda_tests.sh`

---

## Troubleshooting

| Problem | Fix |
|---------|-----|
| Docker not running | Start Docker Desktop / Engine |
| Port 4566 in use | Stop other LocalStack instances: `docker ps` then `docker stop <id>` |
| `testcontainers` can't find Docker socket | On Linux: `sudo chmod 666 /var/run/docker.sock` |
| Tests slow to start | Normal – LocalStack image pull on first run (~1-2 min). Subsequent runs are fast. |

