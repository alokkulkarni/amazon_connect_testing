[
  {
    "name": "TC-001 S3 event → DynamoDB writer (happy path)",
    "description": "Lambda receives an S3 PutObject event, writes metadata to DynamoDB, and returns 200.",
    "function_name": "s3-processor",
    "handler": "lambda_function.lambda_handler",
    "timeout": 10,
    "memory_size": 128,
    "environment_variables": {
      "TABLE_NAME": "ProcessedFilesTable"
    },
    "setup": {
      "s3_buckets": ["incoming-bucket"],
      "dynamodb_tables": [
        {
          "TableName": "ProcessedFilesTable",
          "KeySchema": [{"AttributeName": "file_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "file_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ]
    },
    "trigger_event": {
      "Records": [
        {
          "eventVersion": "2.0",
          "eventSource": "aws:s3",
          "awsRegion": "us-east-1",
          "eventTime": "1970-01-01T00:00:00.000Z",
          "eventName": "ObjectCreated:Put",
          "s3": {
            "s3SchemaVersion": "1.0",
            "configurationId": "testConfigRule",
            "bucket": {
              "name": "incoming-bucket",
              "ownerIdentity": {"principalId": "EXAMPLE"},
              "arn": "arn:aws:s3:::incoming-bucket"
            },
            "object": {
              "key": "test-file.txt",
              "size": 1024,
              "eTag": "0123456789abcdef0123456789abcdef",
              "sequencer": "0A1B2C3D4E5F678901"
            }
          }
        }
      ]
    },
    "validations": {
      "lambda_response": {
        "statusCode": 200,
        "body": "\"File processed successfully\""
      },
      "dynamodb_item": {
        "TableName": "ProcessedFilesTable",
        "Key": {"file_id": {"S": "test-file.txt"}},
        "ExpectedAttributeValue": {
          "status":  {"S": "PROCESSED"},
          "bucket":  {"S": "incoming-bucket"}
        }
      }
    }
  },

  {
    "name": "TC-002 Simple greeting function (happy path)",
    "description": "Lambda returns a customised greeting using GREETING_PREFIX env var.",
    "function_name": "greeter",
    "handler": "lambda_function.lambda_handler_simple",
    "timeout": 5,
    "memory_size": 128,
    "environment_variables": {
      "GREETING_PREFIX": "Hello"
    },
    "setup": {},
    "trigger_event": {"name": "Alice"},
    "validations": {
      "lambda_response": {
        "statusCode": 200,
        "body": "\"Hello, Alice!\""
      }
    }
  },

  {
    "name": "TC-003 Lambda writes output to S3",
    "description": "Lambda receives bucket/key/content and writes an S3 object; validates object content.",
    "function_name": "s3-writer",
    "handler": "lambda_function.lambda_handler_s3_writer",
    "timeout": 10,
    "memory_size": 128,
    "environment_variables": {},
    "setup": {
      "s3_buckets": ["output-bucket"]
    },
    "trigger_event": {
      "bucket":  "output-bucket",
      "key":     "results/report.json",
      "content": "{\"status\": \"ok\"}"
    },
    "validations": {
      "lambda_response": {
        "statusCode": 200,
        "body_contains": "output-bucket"
      },
      "s3_object": {
        "Bucket": "output-bucket",
        "Key":    "results/report.json",
        "ExpectedContent": "{\"status\": \"ok\"}"
      }
    }
  },

  {
    "name": "TC-004 Environment variable passthrough",
    "description": "Validates that all declared environment variables are injected into the Lambda runtime.",
    "function_name": "env-echo",
    "handler": "lambda_function.lambda_handler_env_echo",
    "timeout": 5,
    "memory_size": 128,
    "environment_variables": {
      "APP_ENV":     "test",
      "FEATURE_FLAG": "enabled",
      "MAX_RETRIES": "3"
    },
    "setup": {},
    "trigger_event": {},
    "validations": {
      "lambda_response": {
        "statusCode": 200,
        "body_contains": "APP_ENV"
      }
    }
  },

  {
    "name": "TC-005 Invalid S3 event structure (error path – 400)",
    "description": "Lambda receives a malformed event missing the Records key and should return 400.",
    "function_name": "s3-processor-badrequest",
    "handler": "lambda_function.lambda_handler",
    "timeout": 5,
    "memory_size": 128,
    "environment_variables": {
      "TABLE_NAME": "ProcessedFilesTable"
    },
    "setup": {},
    "trigger_event": {
      "not_records": "this payload is missing the Records key"
    },
    "validations": {
      "lambda_response": {
        "statusCode": 400,
        "body_contains": "Invalid S3 event"
      }
    }
  },

  {
    "name": "TC-006 Missing required env var TABLE_NAME (error path – 500)",
    "description": "Lambda deployed without TABLE_NAME env var should return 500.",
    "function_name": "s3-processor-noenv",
    "handler": "lambda_function.lambda_handler",
    "timeout": 5,
    "memory_size": 128,
    "environment_variables": {},
    "setup": {},
    "trigger_event": {
      "Records": [
        {
          "s3": {
            "bucket": {"name": "any-bucket"},
            "object": {"key": "any-key.txt"}
          }
        }
      ]
    },
    "validations": {
      "lambda_response": {
        "statusCode": 500,
        "body_contains": "TABLE_NAME"
      }
    }
  },

  {
    "name": "TC-007 Unhandled exception triggers FunctionError",
    "description": "Lambda raises an uncaught RuntimeError; FunctionError must be present in the response.",
    "function_name": "raiser",
    "handler": "lambda_function.lambda_handler_raise",
    "timeout": 5,
    "memory_size": 128,
    "environment_variables": {},
    "setup": {},
    "trigger_event": {},
    "validations": {
      "expected_function_error": "Unhandled"
    }
  },

  {
    "name": "TC-008 DynamoDB conditional write – new item created (201)",
    "description": "First write with a unique item_id should succeed and return 201.",
    "function_name": "conditional-writer",
    "handler": "lambda_function.lambda_handler_conditional_write",
    "timeout": 10,
    "memory_size": 128,
    "environment_variables": {
      "TABLE_NAME": "IdempotencyTable"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "IdempotencyTable",
          "KeySchema": [{"AttributeName": "item_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "item_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ]
    },
    "trigger_event": {
      "item_id": "unique-item-001",
      "value":   "first-write"
    },
    "validations": {
      "lambda_response": {
        "statusCode": 201,
        "body_contains": "created"
      },
      "dynamodb_item": {
        "TableName": "IdempotencyTable",
        "Key": {"item_id": {"S": "unique-item-001"}},
        "ExpectedAttributeValue": {
          "value": {"S": "first-write"}
        }
      }
    }
  },

  {
    "name": "TC-009 Chime Handler – NEW_INBOUND_CALL returns empty Actions",
    "description": "SMA fires NEW_INBOUND_CALL. Handler fetches DynamoDB state then immediately returns SchemaVersion 1.0 with an empty Actions array so the call is not dropped.",
    "function_name": "chime-handler-inbound",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-inbound-001"},
            "script": {"S": "[{\"type\": \"dtmf\", \"digits\": \"1\", \"duration_ms\": 500}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "READY"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "NEW_INBOUND_CALL",
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-inbound-001"},
        "Participants": [{"CallId": "call-inbound-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_json": {
        "SchemaVersion": "1.0",
        "Actions": []
      }
    }
  },

  {
    "name": "TC-010 Chime Handler – RINGING returns empty Actions",
    "description": "SMA fires RINGING before the call is answered. Handler should return empty Actions to let the ring continue.",
    "function_name": "chime-handler-ringing",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-ringing-001"},
            "script": {"S": "[{\"type\": \"dtmf\", \"digits\": \"1\", \"duration_ms\": 500}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "READY"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "RINGING",
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-ringing-001"},
        "Participants": [{"CallId": "call-ringing-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_json": {
        "SchemaVersion": "1.0",
        "Actions": []
      }
    }
  },

  {
    "name": "TC-011 Chime Handler – CALL_UPDATE_REQUESTED hangup returns Hangup action",
    "description": "Test framework triggers CALL_UPDATE_REQUESTED with action=hangup (manual teardown). Handler must return a Hangup action.",
    "function_name": "chime-handler-update-hangup",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-update-001"},
            "script": {"S": "[{\"type\": \"dtmf\", \"digits\": \"1\", \"duration_ms\": 500}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "READY"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "CALL_UPDATE_REQUESTED",
      "ActionData": {
        "Parameters": {
          "Arguments": {"action": "hangup"}
        }
      },
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-update-001"},
        "Participants": [{"CallId": "call-update-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_first_action_type": "Hangup"
    }
  },

  {
    "name": "TC-012 Chime Handler – no conversation_id returns empty Actions",
    "description": "Event arrives with no conversation_id in any location. Handler must return empty SchemaVersion 1.0 response without calling DynamoDB.",
    "function_name": "chime-handler-no-convid",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {},
    "trigger_event": {
      "InvocationEventType": "ACTION_SUCCESSFUL",
      "CallDetails": {
        "TransactionAttributes": {},
        "Participants": [{"CallId": "call-no-id-001", "ParticipantTag": "LEG-A"}]
      }
    },
    "validations": {
      "response_json": {
        "SchemaVersion": "1.0",
        "Actions": []
      }
    }
  },

  {
    "name": "TC-013 Chime Handler – CALL_ANSWERED with DTMF step returns SendDigits",
    "description": "Call answered with a DTMF step as the first script action. Handler must return a SendDigits action for the digit in the script.",
    "function_name": "chime-handler-ca-dtmf",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-ca-dtmf-001"},
            "script": {"S": "[{\"type\": \"dtmf\", \"digits\": \"1\", \"duration_ms\": 500}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "READY"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "CALL_ANSWERED",
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-ca-dtmf-001"},
        "Participants": [{"CallId": "call-ca-dtmf-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_first_action_type": "SendDigits"
    }
  },

  {
    "name": "TC-014 Chime Handler – CALL_ANSWERED with Speak step returns Speak action",
    "description": "Call answered with a speak step as the first script action. Handler must return a Speak (TTS) action.",
    "function_name": "chime-handler-ca-speak",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-ca-speak-001"},
            "script": {"S": "[{\"type\": \"speak\", \"text\": \"Hello from Connect\"}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "READY"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "CALL_ANSWERED",
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-ca-speak-001"},
        "Participants": [{"CallId": "call-ca-speak-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_first_action_type": "Speak"
    }
  },

  {
    "name": "TC-015 Chime Handler – ACTION_SUCCESSFUL advances mid-script to Speak step",
    "description": "Script has two steps: DTMF then Speak. Call is at step 0. ACTION_SUCCESSFUL fires (DTMF completed), handler advances to step 1 (Speak) and returns a Speak action.",
    "function_name": "chime-handler-as-mid",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-as-mid-001"},
            "script": {"S": "[{\"type\": \"dtmf\", \"digits\": \"1\", \"duration_ms\": 500}, {\"type\": \"speak\", \"text\": \"Transfer complete\"}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "IN_PROGRESS"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "ACTION_SUCCESSFUL",
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-as-mid-001"},
        "Participants": [{"CallId": "call-as-mid-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_first_action_type": "Speak"
    }
  },

  {
    "name": "TC-016 Chime Handler – ACTION_SUCCESSFUL end-of-script marks COMPLETED",
    "description": "Script has one step (DTMF) at index 0. ACTION_SUCCESSFUL fires; next index (1) >= script length (1), so handler marks the conversation COMPLETED and returns empty Actions.",
    "function_name": "chime-handler-as-eos",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-as-eos-001"},
            "script": {"S": "[{\"type\": \"dtmf\", \"digits\": \"1\", \"duration_ms\": 500}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "IN_PROGRESS"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "ACTION_SUCCESSFUL",
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-as-eos-001"},
        "Participants": [{"CallId": "call-as-eos-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_json": {
        "SchemaVersion": "1.0",
        "Actions": []
      },
      "dynamodb_item": {
        "TableName": "ChimeVoiceState",
        "Key": {"conversation_id": {"S": "chime-as-eos-001"}},
        "ExpectedAttributeValue": {
          "status": {"S": "COMPLETED"}
        }
      }
    }
  },

  {
    "name": "TC-017 Chime Handler – ACTION_FAILED returns Hangup and marks FAILED",
    "description": "A Chime SMA action failed (e.g. TTS error). Handler must hang up the call and write status=FAILED to DynamoDB to prevent zombie calls.",
    "function_name": "chime-handler-action-failed",
    "handler": "lambda_function.lambda_handler",
    "source_file": "../voice_testing/chime_handler_lambda.py",
    "timeout": 15,
    "memory_size": 128,
    "environment_variables": {
      "DYNAMODB_TABLE_NAME": "ChimeVoiceState",
      "ENV_NAME": "test"
    },
    "setup": {
      "dynamodb_tables": [
        {
          "TableName": "ChimeVoiceState",
          "KeySchema": [{"AttributeName": "conversation_id", "KeyType": "HASH"}],
          "AttributeDefinitions": [{"AttributeName": "conversation_id", "AttributeType": "S"}],
          "BillingMode": "PAY_PER_REQUEST"
        }
      ],
      "dynamodb_items": [
        {
          "TableName": "ChimeVoiceState",
          "Item": {
            "conversation_id": {"S": "chime-af-001"},
            "script": {"S": "[{\"type\": \"speak\", \"text\": \"Hello\"}]"},
            "current_step_index": {"N": "0"},
            "status": {"S": "IN_PROGRESS"}
          }
        }
      ]
    },
    "trigger_event": {
      "InvocationEventType": "ACTION_FAILED",
      "ActionData": {
        "ErrorMessage": "SpeakFailed: Polly TTS error"
      },
      "CallDetails": {
        "TransactionAttributes": {"conversation_id": "chime-af-001"},
        "Participants": [{"CallId": "call-af-001", "ParticipantTag": "LEG-A", "Direction": "Inbound"}]
      }
    },
    "validations": {
      "response_first_action_type": "Hangup",
      "dynamodb_item": {
        "TableName": "ChimeVoiceState",
        "Key": {"conversation_id": {"S": "chime-af-001"}},
        "ExpectedAttributeValue": {
          "status": {"S": "FAILED"}
        }
      }
    }
  }
]
